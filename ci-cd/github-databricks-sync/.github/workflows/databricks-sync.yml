name: CI/CD Pipeline - Databricks Sync

on:
  push:
    branches:
      - dev
      - main
  pull_request:
    branches:
      - dev
      - main

env:
  DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
  DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}

jobs:
  test:
    name: Run Unit Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pyyaml pandas scikit-learn numpy
          
      - name: Run unit tests
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          pytest tests/ -v --tb=short
          
      - name: Test results summary
        if: always()
        run: |
          echo "Tests completed. Check output above for details."

  sync:
    name: Sync to Databricks
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push'  # Only sync on pushes, not PRs
    env:
      DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
      DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Needed for detecting deleted files
          
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          
      - name: Install Databricks CLI
        run: |
          python -m pip install --upgrade pip
          pip install databricks-cli
          
      - name: Configure Databricks CLI
        run: |
          echo "[DEFAULT]" > ~/.databrickscfg
          echo "host = ${{ secrets.DATABRICKS_HOST }}" >> ~/.databrickscfg
          echo "token = ${{ secrets.DATABRICKS_TOKEN }}" >> ~/.databrickscfg
          chmod 600 ~/.databrickscfg
          
      - name: Verify Databricks credentials
        run: |
          if [ -z "${{ secrets.DATABRICKS_HOST }}" ] || [ -z "${{ secrets.DATABRICKS_TOKEN }}" ]; then
            echo "ERROR: Databricks secrets are not set!"
            echo "Please add DATABRICKS_HOST and DATABRICKS_TOKEN secrets to GitHub"
            exit 1
          fi
          echo "✓ Databricks credentials verified"
          
      - name: Determine target workspace path
        id: target_path
        run: |
          if [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "workspace_path=/ml-regression-model-prod" >> $GITHUB_OUTPUT
          else
            echo "workspace_path=/ml-regression-model-dev" >> $GITHUB_OUTPUT
          fi
          
      - name: Upload repository files to Databricks
        run: |
          python .github/scripts/sync_to_databricks.py \
            --source-dir "." \
            --target-path "${{ steps.target_path.outputs.workspace_path }}" \
            --branch "${{ github.ref_name }}"
            
      - name: Display sync summary
        run: |
          echo "Workspace Sync Completed"
          echo "Target Path: ${{ steps.target_path.outputs.workspace_path }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"

  cleanup-deleted-files:
    name: Clean up Deleted Files from Databricks
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push'
    env:
      DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
      DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          
      - name: Install Databricks CLI
        run: |
          python -m pip install --upgrade pip
          pip install databricks-cli
          
      - name: Configure Databricks CLI
        run: |
          echo "[DEFAULT]" > ~/.databrickscfg
          echo "host = ${{ secrets.DATABRICKS_HOST }}" >> ~/.databrickscfg
          echo "token = ${{ secrets.DATABRICKS_TOKEN }}" >> ~/.databrickscfg
          chmod 600 ~/.databrickscfg
          
      - name: Verify Databricks credentials
        run: |
          if [ -z "${{ secrets.DATABRICKS_HOST }}" ] || [ -z "${{ secrets.DATABRICKS_TOKEN }}" ]; then
            echo "ERROR: Databricks secrets are not set!"
            echo "Please add DATABRICKS_HOST and DATABRICKS_TOKEN secrets to GitHub"
            exit 1
          fi
          echo "✓ Databricks credentials verified"
          
      - name: Determine target workspace path
        id: target_path
        run: |
          if [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "workspace_path=/ml-regression-model-prod" >> $GITHUB_OUTPUT
          else
            echo "workspace_path=/ml-regression-model-dev" >> $GITHUB_OUTPUT
          fi
          
      - name: Remove deleted files from Databricks
        run: |
          python .github/scripts/cleanup_deleted_files.py \
            --target-path "${{ steps.target_path.outputs.workspace_path }}" \
            --branch "${{ github.ref_name }}"
